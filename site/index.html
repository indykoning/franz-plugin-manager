<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plugin installer</title>
  <meta name="description" content="A plugin installer for Franz">
  <meta name="author" content="Indy Koning">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
</head>
<body class="container">
<form style="margin-top: 100px; width: 100%; text-align: center" onsubmit="submitForm(event)" method="post" action="/api/plugin/add">
    <input type="text" placeholder="https://___.git" id="repository" name="repository">
    <input type="submit" value="Add">
</form>
<div style="text-align: center" id="response"></div>

</div>
<h2 style="text-align: center">installed plugins</h2>
<table style="margin: 0 auto" id="pluginList">
</table>
</body>
<script>
    let recipeList = [];
    let xhr = new XMLHttpRequest();

    xhr.open("GET", "http://localhost:" + window.location.port + "/api/plugin/list");
    xhr.onload = (e) => {
        recipeList = JSON.parse(e.target.responseText);
        let table = document.getElementById('pluginList');
        recipeList.forEach(recipe => {
            let row = document.createElement('tr');
            let nameTd = document.createElement('td');
            let deleteTd = document.createElement('td');
            deleteTd.innerHTML =    '<form onsubmit="if(confirm(\'Are you sure you want to uninstall this plugin?\')){submitForm(event)}" class="deleteform" method="delete" action="/api/plugin/remove">' +
                                    '<input type="hidden" name="recipe" value="' + recipe.directory.substring(recipe.directory.lastIndexOf("/") + 1) + '">' +
                                    '<input type="submit" value="delete">' +
                                    '</form>';
            nameTd.title = recipe.directory;
            nameTd.innerText = recipe.friendlyName;


            row.appendChild(nameTd);
            row.appendChild(deleteTd);
            table.appendChild(row);
        });
    };
    xhr.send();

    function submitForm(e){
        e.preventDefault();
        let formData = new FormData(e.target);
        let body = [...formData.entries()] // expand the elements from the .entries() iterator into an actual array
            .map(e => encodeURIComponent(e[0]) + "=" + encodeURIComponent(e[1]))  // transform the elements into encoded key-value-pair

        xhr.open(e.target.getAttribute('method') ? e.target.getAttribute('method') : e.target.method, e.target.action, true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.onload = (e) => {
            let json = JSON.parse(e.target.responseText);
            switch (json.type){
                case 'clone':
                        document.getElementById('response').innerText = json.result.error !== undefined ? json.result.error : 'Successfully added! To complete installation you\'ll have to restart Franz.';
                    break;
                case 'remove':
                    document.getElementById('response').innerText = json.result;
                    break;
                default:
                    document.getElementById('response').innerText = e.target.responseText;
            }
        };
        xhr.send(body);
    }
</script>
<style>
    td {
        padding: 0 15px;
    }
    .deleteform {
        margin-bottom: auto;
    }
</style>
</html>
